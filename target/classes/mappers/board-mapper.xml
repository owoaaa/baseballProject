<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="boardMapper">

  <select id="selectFreeBoardList" resultType="Board">
    <![CDATA[
      SELECT BOARD_NO, BOARD_TITLE, MEMBER_NO, CREATE_DATE, READ_COUNT, LIKE_COUNT
      FROM BOARD
      WHERE BOARD_TYPE = 'FREE'
      ORDER BY BOARD_NO DESC
    ]]>
  </select>

  <select id="getBoardCount" parameterType="String" resultType="int">
    <![CDATA[
      SELECT COUNT(*) FROM BOARD WHERE BOARD_TYPE = #{boardType}
    ]]>
  </select>

  <select id="selectBoardList" parameterType="map" resultType="Board">
    <![CDATA[
      SELECT * FROM (
        SELECT ROWNUM RNUM, A.* FROM (
          SELECT 
            B.BOARD_NO,
            B.BOARD_TITLE,
            B.CREATE_DATE,
            M.MEMBER_NICK AS MEMBER_NICKNAME,
            NVL(R.REPLY_COUNT, 0) AS REPLY_COUNT,
            NVL(L.LIKE_COUNT, 0) AS LIKE_COUNT
          FROM BOARD B
          JOIN MEMBER M ON B.MEMBER_NO = M.MEMBER_NO
          LEFT JOIN (
            SELECT BOARD_NO, COUNT(*) AS REPLY_COUNT
            FROM REPLY
            GROUP BY BOARD_NO
          ) R ON B.BOARD_NO = R.BOARD_NO
          LEFT JOIN (
            SELECT BOARD_NO, COUNT(*) AS LIKE_COUNT
            FROM "LIKE"
            WHERE LIKE_TYPE = 'LIKE'
            GROUP BY BOARD_NO
          ) L ON B.BOARD_NO = L.BOARD_NO
          WHERE B.BOARD_TYPE = #{boardType}
          ORDER BY B.BOARD_NO DESC
        ) A
        WHERE ROWNUM <= #{endRow}
      )
      WHERE RNUM >= #{startRow}
    ]]>
  </select>

  <!-- 최근 게시글 5개 -->
  <select id="selectRecentBoards" parameterType="int" resultType="Board">
    SELECT BOARD_NO, BOARD_TITLE, CREATE_DATE
    FROM BOARD
    WHERE MEMBER_NO = #{memberNo}
      AND BOARD_ST = 'N'
    ORDER BY CREATE_DATE DESC
    FETCH FIRST 5 ROWS ONLY
  </select>

  <!-- 최근 댓글 5개 -->
  <resultMap id="recentReplyResultMap" type="Reply">
    <result property="replyNo" column="REPLY_NO" />
    <result property="replyContent" column="REPLY_CONTENT" />
    <result property="replyCreateDate" column="REPLY_CREATE_DATE" />
    <association property="board" javaType="Board">
      <result property="boardNo" column="BOARD_NO" />
      <result property="boardTitle" column="BOARD_TITLE" />
      <result property="createDate" column="BOARD_CREATE_DATE" />
    </association>
  </resultMap>

  <select id="selectRecentReplies" parameterType="int" resultMap="recentReplyResultMap">
    SELECT 
      R.REPLY_NO, R.REPLY_CONTENT, R.REPLY_CREATE_DATE,
      B.BOARD_NO, B.BOARD_TITLE, B.CREATE_DATE AS BOARD_CREATE_DATE
    FROM REPLY R
    JOIN BOARD B ON R.BOARD_NO = B.BOARD_NO
    WHERE R.MEMBER_NO = #{memberNo}
      AND R.REPLY_ST = 'N'
    ORDER BY R.REPLY_CREATE_DATE DESC
    FETCH FIRST 5 ROWS ONLY
  </select>

  <!-- 마이페이지 내가 쓴 게시글 / 댓글 -->
  <!-- 게시글 수 -->
  <select id="getMyPostCount" resultType="int">
    SELECT COUNT(*) FROM BOARD
    WHERE MEMBER_NO = #{memberNo}
      AND BOARD_ST = 'N'
  </select>

  <!-- 게시글 목록 (ROWNUM 방식) -->
  <select id="getMyPostList" resultType="Board">
    <![CDATA[
    SELECT * FROM (
      SELECT ROWNUM RNUM, TMP.* FROM (
        SELECT 
          BOARD_NO, 
          BOARD_TITLE, 
          CREATE_DATE,
          (SELECT COUNT(*) FROM REPLY WHERE BOARD_NO = B.BOARD_NO AND REPLY_ST = 'N') AS REPLY_COUNT,
          (SELECT COUNT(*) FROM "LIKE" WHERE BOARD_NO = B.BOARD_NO) AS LIKE_COUNT
        FROM BOARD B
        WHERE MEMBER_NO = #{memberNo}
          AND BOARD_ST = 'N'
        ORDER BY CREATE_DATE DESC
      ) TMP
      WHERE ROWNUM <= #{endRow}
    )
    WHERE RNUM >= #{startRow}
    ]]>
  </select>

  <!-- 댓글 수 -->
  <select id="getMyReplyCount" resultType="int">
    SELECT COUNT(*) FROM REPLY
    WHERE MEMBER_NO = #{memberNo}
      AND REPLY_ST = 'N'
  </select>

  <!-- 댓글 목록 (ROWNUM 방식) -->
  <resultMap id="myReplyResultMap" type="Reply">
    <result property="replyNo" column="REPLY_NO" />
    <result property="replyContent" column="REPLY_CONTENT" />
    <result property="replyCreateDate" column="REPLY_CREATE_DATE" />
    <association property="board" javaType="Board">
      <result property="boardNo" column="BOARD_NO" />
      <result property="boardTitle" column="BOARD_TITLE" />
      <result property="createDate" column="BOARD_CREATE_DATE" />
    </association>
  </resultMap>

  <select id="getMyReplyList" resultMap="myReplyResultMap">
    <![CDATA[
    SELECT * FROM (
      SELECT ROWNUM RNUM, TEMP.*
      FROM (
        SELECT 
          R.REPLY_NO, R.REPLY_CONTENT, R.REPLY_CREATE_DATE,
          B.BOARD_NO, B.BOARD_TITLE, B.CREATE_DATE AS BOARD_CREATE_DATE
        FROM REPLY R
        JOIN BOARD B ON R.BOARD_NO = B.BOARD_NO
        WHERE R.MEMBER_NO = #{memberNo}
          AND R.REPLY_ST = 'N'
        ORDER BY R.REPLY_CREATE_DATE DESC
      ) TEMP
      WHERE ROWNUM <= #{endRow}
    )
    WHERE RNUM >= #{startRow}
    ]]>
  </select>

</mapper>